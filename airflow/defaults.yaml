# -*- coding: utf-8 -*-
# vim: ft=yaml
---
airflow:
  dir:
    airflow:
      lib: /var/lib/airflow
      tmp: /tmp/airflow
      service: /lib/systemd/system
      environ: /etc/sysconfig
      base: /home   # os sensitive user homedir
      userhome: null    # AIRFLOW_HOME is set by pillar data, otherwise map.jinja
      virutalenv: null  # set by pillar data, otherwise map.jinja
  security:
    airflow:
      user: airflow
      pass: airflow
      email: airflow@localhost
      script: {{ range(1,200000) | random }}.py
  config:
    airflow:
      file: airflow.cfg
      initcmd: 'db init'
      content:
        scheduler:
          child_process_log_directory: /home/airflow/airflow/logs/schedule
        core:
          dags_folder: /home/airflow/dags
          plugins_folder: /home/airflow/plugins
          base_log_folder: /home/airflow/airflow/logs
          executor: CeleryExecutor
          default_timezone: system
          # https://stackoverflow.com/questions/45455342
          sql_alchemy_conn: postgresql+psycopg2://airflow:airflow@127.0.0.1/airflow
          sql_alchemy_pool_enabled: true
          sql_alchemy_max_overflow: 10
          sql_alchemy_pool_recycle: 1800
          parallelism: 32
          dag_concurrency: 16
          max_active_runs_per_dag: 16
          dagbag_import_timeout: 30
          dag_file_processor_timeout: 50
          security: ''
          load_examples: False
        webserver:
          authenticate: true
          secret_key: {{ range(1,20000000000) | random }}
          auth_backend: airflow.contrib.auth.backends.password_auth
          cookie_samesite: Lax
          expose_config: true
        secrets:
          backend: ''
          backend_kwargs: ''
        celery:
          # https://docs.celeryproject.org/en/v5.0.2/getting-started/brokers
          broker_url: redis://127.0.0.1:6379/0
          result_backend: db+postgresql://airflow:airflow@127.0.0.1/airflow
      state_colors: {}
      # https://airflow.apache.org/docs/apache-airflow/stable/howto/customize-state-colors-ui.html

  environ:
    airflow:
      file: airflow
      content: {}
  service:
    airflow:
      names:
        - airflow-celery-flower
        - airflow-scheduler
        - airflow-webserver
        - airflow-celery-worker
      enabled:
        - airflow-celery-flower
        - airflow-scheduler
        - airflow-webserver
        - airflow-celery-worker
  pkg:
    airflow:
      version: 2.0.0  # 1.10.14
      use_upstream: pip
      name: apache-airflow
      commands:
        - airflow
      uri_a: https://github.com/apache/airflow/releases/download
      uri_c: https://raw.githubusercontent.com/apache/airflow/constraints-VERSION/constraints-PYVER.txt
      archive:
        options: '--strip-components=1'
      suffix: tar.gz
      deps: []
      extras:
        - celery
        - postgres
        - google
        - password
        - cncf.kerberos
        - devel_ci
        - devel_azure
        # apache-airflow-backport-providers-microsoft-winrm    # v1
        - apache-airflow-providers-microsoft-winrm
      pips:
        # for functionality
        - cryptography
            {%- if grains.os_family == 'RedHat' %}
        - psycopg2-binary
            {%- else %}
        - psycopg2
        - mysqlclient
            {%- endif %}
        - password
        - mysql-connector
        - attr
        - flask_oauthlib
        - great_expectations
        - flask-bcrypt
        # from airflow's setup.py
        - alembic
        - argcomplete
        - attrs
        - cached_property
        - cattrs==1.0.0
        - pywinrm[kerberos]

        # https://github.com/mher/flower/issues/1029
        # https://docs.celeryproject.org/en/v5.0.2/getting-started/brokers
        - celery[redis,sqs]==4.4.7
        - colorlog
        - configparser
        - croniter
        - dill
        - email-validator
        - flask
        - flask-admin
        - flask-appbuilder
        - flask-caching
        - flask-login
        - flask-swagger
        - flask-wtf
        - flower
        - funcsigs
        - future
        - graphviz
        - gunicorn
        - importlib-metadata
        - iso8601
        - jinja2
        - json-merge-patch
        - jsonschema
        - lazy_object_proxy
        - markdown
        - marshmallow-sqlalchemy
        - marshmallow-sqlalchemy
        - packaging
        - pandas
        - pendulum
        - pep562
        - psutil
        - pygments
        - python-daemon
        - python-dateutil
        - python-nvd3
        - python-slugify
        - requests
        - setproctitle
        - sqlalchemy
        - sqlalchemy_jsonfield
        - sqlalchemy_jsonfield
        - tabulate
        - tenacity
        - thrift
        - typing
        - typing-extensions
        - tzlocal
        - unicodecsv
        - werkzeug
        - zope.deprecation
        - idna
        - jsonpointer
        - rfc3987
        - strict-rfc3339
        - webcolors
        - pyarrow<0.18.0,>=0.17.0
        # bug: https://github.com/apache/airflow/issues/12881
        - apache-airflow-providers-snowflake==1.0.0
  identity:
    rootuser: root
    rootgroup: root
    airflow:
      user: airflow
      group: airflow
  misc:
    refresh: true
    reload: true
    clean: false
  linux:
    altpriority: 0   # zero disables alternatives
  retry_option:
    # https://docs.saltstack.com/en/latest/ref/states/requisites.html#retrying-states
    attempts: 3
    until: true
    interval: 60
    splay: 10
  div: '/'

  # Just here for testing
  added_in_defaults: defaults_value
  winner: defaults

  # Just here as experiemnt/documentation
  supported:
    - airflow
  wanted:
    - airflow
  depends:
    - postgresql
    - redis
